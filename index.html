<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>財運タイムアタック（15秒 / 投資アプリ風）</title>
  <style>
    :root{
      --bg:#0b0f1a;
      --panelA: rgba(10,16,40,.95);
      --panelB: rgba(7,10,22,.95);
      --line: rgba(34,48,106,.92);
      --txt:#e8ecff;
      --muted: rgba(232,236,255,.74);
      --muted2: rgba(232,236,255,.55);
      --chip: rgba(13,20,51,.72);
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--txt);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;}
    .wrap{max-width:1020px;margin:0 auto;padding:16px;display:flex;flex-direction:column;gap:12px;}
    .top{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .stats{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{
      background:var(--chip);
      backdrop-filter: blur(6px);
      border:1px solid rgba(34,48,106,.9);
      border-radius:999px;
      padding:8px 12px;
      font-size:13px
    }
    .pill b{font-size:14px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{
      background:#1b2550;color:#fff;border:1px solid #2a3a7a;border-radius:12px;
      padding:9px 12px;cursor:pointer
    }
    button:active{transform:translateY(1px)}
    button.secondary{background:transparent;border:1px solid rgba(34,48,106,.95);color:var(--txt)}
    button.big{padding:14px 16px;border-radius:16px;font-weight:1000;font-size:16px;letter-spacing:.02em}
    .grid{display:grid;grid-template-columns: 1.2fr .8fr; gap:12px}
    @media (max-width:900px){ .grid{grid-template-columns:1fr;} }

    .panel{
      border-radius:18px; padding:14px; position:relative; overflow:hidden;
      border:1px solid var(--line);
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(147,180,255,.10), rgba(0,0,0,0)),
        radial-gradient(1200px 600px at 90% 0%, rgba(255,77,109,.08), rgba(0,0,0,0)),
        linear-gradient(180deg, var(--panelA), var(--panelB));
      box-shadow: 0 22px 55px rgba(0,0,0,.35);
    }
    .panel.right{background:linear-gradient(180deg, var(--panelA), var(--panelB));}

    .title{font-weight:1000;font-size:18px}
    .hint{font-size:13px;color:var(--muted);line-height:1.55}
    .tiny{font-size:12px;color:rgba(232,236,255,.72)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}

    /* reserve space for fortuneBar */
    .center{
      display:flex;flex-direction:column;gap:12px;align-items:center;justify-content:center;
      min-height:540px;
      padding-top:82px;
    }
    .moneyBig{font-size:46px;font-weight:1000;letter-spacing:.02em;text-shadow:0 10px 26px rgba(0,0,0,.45)}
    .subRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center}

    .drawBtn{
      width:min(420px, 84vw);
      padding:18px 18px;
      border-radius:22px;
      background:radial-gradient(circle at 30% 30%, rgba(255,255,255,.18), rgba(0,0,0,0)),
                 linear-gradient(180deg, rgba(255,212,59,.98), rgba(240,180,41,.88));
      border:2px solid rgba(255,255,255,.22);
      box-shadow:0 18px 40px rgba(0,0,0,.40), inset 0 8px 18px rgba(255,255,255,.22);
      cursor:pointer; user-select:none; -webkit-tap-highlight-color:transparent;
      display:flex; align-items:center; justify-content:center;
      color:#2a1f00;
      transition: transform .06s ease, filter .2s ease;
      font-weight:1000;
      font-size:18px;
      letter-spacing:.04em;
    }
    .drawBtn:active{transform:scale(.985)}
    .drawBtn.disabled{opacity:.55; pointer-events:none; filter:grayscale(.2);}

    .sideBtn{
      width:min(200px, 40vw);
      padding:14px 12px;
      border-radius:16px;
      background:rgba(13,20,51,.78);
      border:1px solid rgba(34,48,106,.9);
      box-shadow:0 16px 34px rgba(0,0,0,.28);
      font-weight:1000;
    }
    .sideBtn.good{border-color:rgba(255,120,120,.6)}
    .sideBtn.bad{border-color:rgba(120,150,180,.55)}
    .sideBtn.disabled{opacity:.55; pointer-events:none; filter:grayscale(.2);}
    .smallRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center}

    /* Fortune Bar (別表紙) */
    .fortuneBar{
      position:absolute;
      left:14px; right:14px; top:14px;
      height:64px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 14px;
      gap:12px;
      box-shadow: 0 12px 28px rgba(0,0,0,.35);
      z-index: 3;
    }
    .fortuneLabel{
      font-weight:1000;
      font-size:26px;
      letter-spacing:.04em;
      text-shadow:0 10px 28px rgba(0,0,0,.55);
      white-space:nowrap;
    }
    .fortuneDelta{
      font-weight:900;
      font-size:14px;
      color:rgba(232,236,255,.92);
      opacity:.95;
      white-space:nowrap;
      text-align:right;
      line-height:1.25;
    }

    /* 大吉ほど赤、凶ほど暗い */
    .fortune-daikichi { background: linear-gradient(90deg, rgba(255,60,60,.55), rgba(0,0,0,.20)); }
    .fortune-chukichi { background: linear-gradient(90deg, rgba(255,110,60,.45), rgba(0,0,0,.20)); }
    .fortune-shokichi { background: linear-gradient(90deg, rgba(255,170,70,.34), rgba(0,0,0,.20)); }
    .fortune-kichi    { background: linear-gradient(90deg, rgba(230,220,120,.22), rgba(0,0,0,.20)); }
    .fortune-suekichi { background: linear-gradient(90deg, rgba(180,190,210,.18), rgba(0,0,0,.20)); }
    .fortune-kyo      { background: linear-gradient(90deg, rgba(90,110,130,.22), rgba(0,0,0,.28)); }
    .fortune-daikyo   { background: linear-gradient(90deg, rgba(10,14,22,.55), rgba(0,0,0,.35)); }

    .fortune-daikichi .fortuneLabel{color: rgba(255,90,90,1);}
    .fortune-chukichi .fortuneLabel{color: rgba(255,140,90,1);}
    .fortune-shokichi .fortuneLabel{color: rgba(255,200,120,1);}
    .fortune-kichi    .fortuneLabel{color: rgba(255,240,170,1);}
    .fortune-suekichi .fortuneLabel{color: rgba(210,220,240,1);}
    .fortune-kyo      .fortuneLabel{color: rgba(170,190,215,1);}
    .fortune-daikyo   .fortuneLabel{color: rgba(160,160,175,1);}

    .toast{
      position:absolute;left:14px;top:88px;
      background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.12);
      padding:8px 10px;border-radius:12px;font-size:13px;
      opacity:0;transform:translateY(-6px);transition:.18s;
      backdrop-filter: blur(8px);
      z-index: 3;
    }
    .toast.show{opacity:1;transform:translateY(0)}

    .float{
      position:absolute; pointer-events:none; font-weight:950;
      text-shadow:0 2px 16px rgba(0,0,0,.45);
      animation: floatUp .95s cubic-bezier(.12,.9,.2,1) forwards;
      will-change: transform, opacity;
      letter-spacing:.02em;
      z-index: 3;
    }
    @keyframes floatUp{
      0%{transform:translate(-50%,-8px) scale(1); opacity:1}
      100%{transform:translate(-50%,-120px) scale(1.22); opacity:0}
    }

    canvas.fx{ position:absolute; inset:0; width:100%; height:100%; pointer-events:none; z-index:2; }

    .card{
      background:rgba(13,20,51,.78);
      backdrop-filter: blur(8px);
      border:1px solid rgba(34,48,106,.9);
      border-radius:14px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    select{
      background:rgba(13,20,51,.9); color:var(--txt);
      border:1px solid rgba(34,48,106,.95); border-radius:12px;
      padding:10px 12px; font-size:14px; min-width:260px;
    }
    .hr{height:1px;background:rgba(255,255,255,.08);margin:8px 0}
    .badge{
      display:inline-block; padding:3px 8px; border-radius:999px;
      border:1px solid rgba(34,48,106,.9);
      background:rgba(147,180,255,.12);
      font-size:12px;
    }

    /* 投資アプリ風チャート */
    .chartWrap{
      background:rgba(0,0,0,.16);
      border:1px solid rgba(34,48,106,.85);
      border-radius:14px;
      padding:10px;
      overflow:hidden;
    }
    .chartHeader{
      display:flex; align-items:baseline; justify-content:space-between; gap:10px;
      padding:2px 2px 8px 2px;
    }
    .chartNow{font-weight:1000;font-size:16px;}
    .chartSub{font-size:12px;color:var(--muted2);white-space:nowrap;}
    #moneyChart{ width:100%; height:220px; display:block; }
    .chartFoot{
      font-size:12px;color:var(--muted2);
      display:flex; justify-content:space-between;
      padding:6px 2px 0 2px;
    }

    /* Result modal */
    .modalBackdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; padding:18px;
    }
    .modal{
      width:min(820px, 100%); background:#0c122a; border:1px solid rgba(34,48,106,.95);
      border-radius:18px; padding:16px; box-shadow:0 30px 80px rgba(0,0,0,.55);
    }
    .modal h2{margin:0 0 8px 0; font-size:22px}
    .resultCard{
      background:rgba(13,20,51,.78); border:1px solid rgba(34,48,106,.9); border-radius:14px;
      padding:14px; line-height:1.7;
    }
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid rgba(255,255,255,.10);padding:8px 6px;text-align:left;font-size:13px}
    th{color:rgba(232,236,255,.85)}
    .resultBig{font-size:26px;font-weight:1000}
    .modalBtns{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:12px}

    @media print{
      body{background:#fff;color:#000}
      .wrap, .top, .grid, .panel, .actions, .stats, .hint, canvas.fx, .toast, .fortuneBar{display:none !important;}
      .modalBackdrop{position:static; inset:auto; background:none; display:block !important; padding:0}
      .modal{box-shadow:none; border:0; border-radius:0; padding:0}
      .modalBtns{display:none !important;}
      .resultCard{border:1px solid #000; background:#fff}
      th,td{border-bottom:1px solid #000;color:#000}
      .badge{border:1px solid #000;background:#fff}
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="stats">
      <div class="pill">残り：<b id="time">15.0</b>s</div>
      <div class="pill">所持金：<b id="money">10,000</b>円</div>
      <div class="pill">開始：<b class="mono">¥10,000</b></div>
      <div class="pill">モード：<b id="modeName">未選択</b></div>
      <div class="pill">回数：<b id="presses">0</b></div>
      <div class="pill">偏り：<b id="biasMeter">0.00</b></div>
      <div class="pill">リズム：<b id="rhythmMeter">0.00</b></div>
    </div>
    <div class="actions">
      <button id="btnAudio">Audio ON</button>
      <button id="btnReset" class="secondary">Reset</button>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT -->
    <div class="panel" id="leftPanel">
      <canvas class="fx" id="fx"></canvas>

      <div class="fortuneBar fortune-kichi" id="fortuneBar">
        <div class="fortuneLabel" id="fortuneLabel">—</div>
        <div class="fortuneDelta mono" id="fortuneDelta"></div>
      </div>

      <div class="toast" id="toast"></div>

      <div class="center">
        <div class="moneyBig mono" id="moneyBig">¥10,000</div>
        <div class="hint">
          15秒で、所持金10,000円をどれだけ増やせるか（借金もあり）。<br>
          <b>リズム良く押すと大吉寄り</b>。<b>連打＆不安定だと凶寄り</b>。<br>
          「ありがとう／もっと頑張れよ」で運勢の偏りも操作できる。
        </div>

        <div class="drawBtn disabled" id="drawBtn">財運を引く（押す）</div>

        <div class="smallRow">
          <button class="sideBtn good disabled" id="btnThanks">ありがとう</button>
          <button class="sideBtn bad disabled" id="btnHarsh">もっと頑張れよ</button>
        </div>

        <div class="subRow">
          <button class="big" id="btnStart">スタート（15秒）</button>
          <button class="big secondary" id="btnEnd">終了（結果）</button>
        </div>

        <div class="tiny">※ 所持金はマイナスもOK（借金）。</div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="panel right">
      <div class="card">
        <div class="title">モード選択</div>
        <div class="tiny">基本の出やすさと振れ幅が変わる。</div>
        <div class="row">
          <select id="mode">
            <option value="steady">安定（凶が出にくい／増減は小さめ）</option>
            <option value="balanced" selected>バランス（ほどよく増減）</option>
            <option value="risky">博打（大吉も凶も出やすい／増減が激しい）</option>
          </select>
        </div>

        <div class="hr"></div>

        <div class="title">一般的な7段階</div>
        <div class="tiny">大吉 ＞ 中吉 ＞ 小吉 ＞ 吉 ＞ 末吉 ＞ 凶 ＞ 大凶</div>
        <div class="row">
          <span class="badge">大吉</span>
          <span class="badge">中吉</span>
          <span class="badge">小吉</span>
          <span class="badge">吉</span>
          <span class="badge">末吉</span>
          <span class="badge">凶</span>
          <span class="badge">大凶</span>
        </div>

        <div class="hr"></div>

        <div class="title">所持金 推移（リアルタイム）</div>
        <div class="tiny">15秒の変化が線で見える（投資アプリ風）</div>

        <div class="chartWrap">
          <div class="chartHeader">
            <div class="chartNow mono" id="chartNow">¥10,000</div>
            <div class="chartSub mono" id="chartNet">±0</div>
          </div>
          <canvas id="moneyChart"></canvas>
          <div class="chartFoot mono">
            <span>0s</span><span>7.5s</span><span>15s</span>
          </div>
        </div>

        <div class="hr"></div>

        <div class="hint">
          総合判定（5段階）：<br>
          <b>大吉／中吉／小吉／吉／末吉</b>（獲得額で判定）<br>
          ※ 凶・大凶が出ても、総合判定はこの5段階でまとめる
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Result Modal -->
<div class="modalBackdrop" id="modalBackdrop">
  <div class="modal">
    <h2>結果</h2>
    <div class="resultCard">
      <div class="resultBig" id="resultTitle">総合判定：—</div>
      <div id="resultSummary" style="margin-top:6px"></div>

      <table>
        <thead><tr><th>運勢</th><th>回数</th><th>割合</th></tr></thead>
        <tbody id="countTable"></tbody>
      </table>

      <div style="margin-top:10px" id="resultTypeLine"></div>
      <div style="margin-top:6px" id="resultAdviceLine"></div>
      <div style="margin-top:10px">お疲れ様でした。</div>
    </div>

    <div class="modalBtns">
      <button class="secondary" id="btnClose">閉じる</button>
      <button id="btnPrint">印刷</button>
      <button id="btnAgain">もう一回</button>
    </div>
  </div>
</div>

<script>
(() => {
  // ===== Config =====
  const GAME_SECONDS = 15;   // ← 15秒に修正
  const CHART_TMAX   = 15;

  // ===== DOM =====
  const timeEl = document.getElementById("time");
  const moneyEl = document.getElementById("money");
  const moneyBigEl = document.getElementById("moneyBig");
  const pressesEl = document.getElementById("presses");
  const modeNameEl = document.getElementById("modeName");
  const biasMeterEl = document.getElementById("biasMeter");
  const rhythmMeterEl = document.getElementById("rhythmMeter");

  const leftPanel = document.getElementById("leftPanel");
  const drawBtn = document.getElementById("drawBtn");
  const btnThanks = document.getElementById("btnThanks");
  const btnHarsh = document.getElementById("btnHarsh");
  const btnStart = document.getElementById("btnStart");
  const btnEnd = document.getElementById("btnEnd");
  const btnAudio = document.getElementById("btnAudio");
  const btnReset = document.getElementById("btnReset");
  const modeSel = document.getElementById("mode");

  const toastEl = document.getElementById("toast");
  const fortuneBar = document.getElementById("fortuneBar");
  const fortuneLabel = document.getElementById("fortuneLabel");
  const fortuneDelta = document.getElementById("fortuneDelta");

  const modalBackdrop = document.getElementById("modalBackdrop");
  const resultTitle = document.getElementById("resultTitle");
  const resultSummary = document.getElementById("resultSummary");
  const countTable = document.getElementById("countTable");
  const resultTypeLine = document.getElementById("resultTypeLine");
  const resultAdviceLine = document.getElementById("resultAdviceLine");
  const btnClose = document.getElementById("btnClose");
  const btnPrint = document.getElementById("btnPrint");
  const btnAgain = document.getElementById("btnAgain");

  const chartNowEl = document.getElementById("chartNow");
  const chartNetEl = document.getElementById("chartNet");

  // ===== Helpers =====
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  function moneyInt(){ return Math.floor(state.money + (state.money>=0?1e-9:-1e-9)); }
  function fmtYen(n){
    const abs = Math.floor(Math.abs(n));
    const s = "¥" + abs.toLocaleString("ja-JP");
    return n < 0 ? ("-" + s) : s;
  }
  function fmtNet(n){
    const abs = Math.floor(Math.abs(n));
    const s = abs.toLocaleString("ja-JP");
    return n < 0 ? ("-" + s) : ("+" + s);
  }

  // ===== Audio =====
  let audioCtx = null;
  let audioUnlocked = false;
  let muted = false;
  function ensureAudio(){
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === "suspended") audioCtx.resume();
    audioUnlocked = true;
  }
  function beep({freq=440, dur=0.06, type="sine", gain=0.05, when=0, slide=0}={}){
    if (muted || !audioUnlocked) return;
    ensureAudio();
    const t0 = audioCtx.currentTime + when;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type;
    o.frequency.setValueAtTime(freq, t0);
    if (slide) o.frequency.exponentialRampToValueAtTime(Math.max(30, freq + slide), t0 + dur);
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(gain, t0 + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
    o.connect(g).connect(audioCtx.destination);
    o.start(t0);
    o.stop(t0 + dur + 0.02);
  }
  const sfx = {
    tap(){ beep({freq: 880, dur:0.045, type:"square", gain:0.035, slide:-220}); },
    good(){ beep({freq: 659, dur:0.08, type:"triangle", gain:0.06}); beep({freq: 880, dur:0.10, type:"triangle", gain:0.06, when:0.08}); },
    bad(){  beep({freq: 180, dur:0.10, type:"sawtooth", gain:0.05, slide:-60}); },
    boom(){ beep({freq: 220, dur:0.12, type:"sawtooth", gain:0.06, slide:-120}); beep({freq: 440, dur:0.10, type:"triangle", gain:0.05, when:0.06}); },
    end(){  beep({freq: 784, dur:0.10, type:"triangle", gain:0.06}); beep({freq: 659, dur:0.10, type:"triangle", gain:0.06, when:0.11}); beep({freq: 523, dur:0.12, type:"triangle", gain:0.06, when:0.22}); },
    thanks(){ beep({freq: 523, dur:0.07, type:"triangle", gain:0.06}); beep({freq: 659, dur:0.08, type:"triangle", gain:0.06, when:0.07}); },
    harsh(){ beep({freq: 220, dur:0.08, type:"sawtooth", gain:0.05}); }
  };

  // ===== FX Canvas =====
  const fx = document.getElementById("fx");
  const fctx = fx.getContext("2d");
  const DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  const particles = [];
  const rings = [];
  function rand(a,b){ return a + Math.random()*(b-a); }
  function hsl(h,s,l,a=1){ return `hsla(${h},${s}%,${l}%,${a})`; }
  function resizeFx(){
    const r = leftPanel.getBoundingClientRect();
    fx.width = Math.floor(r.width * DPR);
    fx.height = Math.floor(r.height * DPR);
  }
  window.addEventListener("resize", resizeFx);
  function pushSparks(x,y,amount=20,power=1){
    for (let i=0;i<amount;i++){
      const ang = rand(0, Math.PI*2);
      const sp = rand(160, 420)*power;
      const hue = (Math.random()*360)|0;
      particles.push({
        type:"spark",
        x,y, vx:Math.cos(ang)*sp, vy:Math.sin(ang)*sp,
        g: rand(480, 820),
        life: rand(0.45, 0.75),
        t: 0,
        r: rand(1.2, 2.6),
        color: hsl(hue, 98, 64, 0.95)
      });
    }
  }
  function pushConfetti(burst=60){
    const r = leftPanel.getBoundingClientRect();
    const cx = r.width*0.5, cy=r.height*0.30;
    for (let i=0;i<burst;i++){
      const hue = (Math.random()*360)|0;
      particles.push({
        type:"confetti",
        x: cx + rand(-60,60),
        y: cy + rand(-30,30),
        vx: rand(-160,160),
        vy: rand(-280,-140),
        g: rand(380,520),
        life: rand(1.1, 1.9),
        t: 0,
        rot: rand(0,Math.PI*2),
        vr: rand(-10,10),
        w: rand(5,11),
        h: rand(9,18),
        color: hsl(hue, 95, 60, 0.95)
      });
    }
  }
  function pushRing(x,y){
    rings.push({x,y,r:10,vr:520,life:0.55,t:0,color:hsl(rand(0,360),95,62,0.75)});
  }
  function fxLoop(now){
    fctx.clearRect(0,0,fx.width,fx.height);
    fctx.save(); fctx.scale(DPR,DPR);
    const dt = Math.min(0.033, (fxLoop._last ? (now - fxLoop._last)/1000 : 0.016));
    fxLoop._last = now;

    for (let i=rings.length-1;i>=0;i--){
      const it=rings[i]; it.t += dt; it.r += it.vr*dt;
      const a = 1 - (it.t / it.life);
      if (a<=0){ rings.splice(i,1); continue; }
      fctx.beginPath();
      fctx.strokeStyle = it.color.replace("0.75", String(0.75*a));
      fctx.lineWidth = 4*a;
      fctx.arc(it.x,it.y,it.r,0,Math.PI*2);
      fctx.stroke();
    }
    for (let i=particles.length-1;i>=0;i--){
      const p=particles[i]; p.t += dt;
      const a = 1 - (p.t / p.life);
      if (a<=0){ particles.splice(i,1); continue; }
      p.vy += p.g*dt; p.x += p.vx*dt; p.y += p.vy*dt;

      if (p.type==="confetti"){
        p.rot += p.vr*dt;
        fctx.save();
        fctx.translate(p.x,p.y);
        fctx.rotate(p.rot);
        fctx.globalAlpha = Math.max(0,a);
        fctx.fillStyle = p.color;
        fctx.fillRect(-p.w/2,-p.h/2,p.w,p.h);
        fctx.restore();
      } else {
        fctx.globalAlpha = Math.max(0,a);
        fctx.fillStyle = p.color;
        fctx.beginPath();
        fctx.arc(p.x,p.y,p.r,0,Math.PI*2);
        fctx.fill();
      }
    }
    fctx.restore();
    requestAnimationFrame(fxLoop);
  }

  // ===== UI helpers =====
  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(()=>toastEl.classList.remove("show"), 950);
  }
  function spawnFloat(text, x, y, size=18, color="rgba(255,212,59,1)"){
    const el=document.createElement("div");
    el.className="float";
    el.textContent=text;
    el.style.left=x+"px";
    el.style.top=y+"px";
    el.style.fontSize=size+"px";
    el.style.color=color;
    leftPanel.appendChild(el);
    setTimeout(()=>el.remove(), 1000);
  }

  // ===== Fortune Bar =====
  function fortuneClass(name){
    return {
      "大吉":"fortune-daikichi",
      "中吉":"fortune-chukichi",
      "小吉":"fortune-shokichi",
      "吉":"fortune-kichi",
      "末吉":"fortune-suekichi",
      "凶":"fortune-kyo",
      "大凶":"fortune-daikyo",
    }[name] || "fortune-kichi";
  }
  function showFortuneBar(name, delta, infoLine=""){
    fortuneBar.classList.remove(
      "fortune-daikichi","fortune-chukichi","fortune-shokichi",
      "fortune-kichi","fortune-suekichi","fortune-kyo","fortune-daikyo"
    );
    fortuneBar.classList.add(fortuneClass(name));
    fortuneLabel.textContent = name;

    let line1 = "";
    if (typeof delta === "number"){
      line1 = `${delta>=0?"+":"-"}${fmtYen(Math.abs(delta))}`;
    }
    fortuneDelta.innerHTML = `${line1}${infoLine ? "<br>"+infoLine : ""}`;

    fortuneBar.animate(
      [{transform:"scale(1)", filter:"brightness(1)"},
       {transform:"scale(1.012)", filter:"brightness(1.12)"},
       {transform:"scale(1)", filter:"brightness(1)"}],
      {duration:200, easing:"ease-out"}
    );
  }

  // ===== Fortune System =====
  const ORDER = ["大吉","中吉","小吉","吉","末吉","凶","大凶"];
  const modeWeights = {
    steady:   [10, 14, 18, 22, 22, 10,  4],
    balanced: [ 9, 12, 16, 22, 22, 12,  7],
    risky:    [12, 13, 12, 18, 15, 18, 12],
  };
  const modeLabel = { steady:"安定", balanced:"バランス", risky:"博打" };
  const fortuneMult = { "大吉": +12, "中吉": +7, "小吉": +4, "吉": +2, "末吉": +1, "凶": -4, "大凶": -9 };
  const modeVolatility = { steady:0.85, balanced:1.0, risky:1.25 };

  function weightedPick(names, weights){
    const total = weights.reduce((a,b)=>a+b,0);
    let r = Math.random()*total;
    for (let i=0;i<weights.length;i++){
      r -= weights[i];
      if (r<=0) return names[i];
    }
    return names[names.length-1];
  }
  function applyInfluenceToWeights(baseW, bias, rhythm){
    const w = baseW.slice();
    const influ = clamp(0.55*bias + 0.75*rhythm, -1, 1);
    const goodBoost = Math.max(0, influ);
    const badBoost  = Math.max(0, -influ);

    w[0] *= (1 + 0.85*goodBoost);
    w[1] *= (1 + 0.55*goodBoost);
    w[2] *= (1 + 0.35*goodBoost);
    w[3] *= (1 - 0.18*goodBoost);
    w[4] *= (1 - 0.10*goodBoost);

    w[5] *= (1 + 0.70*badBoost);
    w[6] *= (1 + 1.10*badBoost);

    w[0] *= (1 - 0.22*badBoost);
    w[1] *= (1 - 0.18*badBoost);
    w[2] *= (1 - 0.12*badBoost);

    for (let i=0;i<w.length;i++) w[i] = Math.max(0.5, w[i]);
    return w;
  }

  function computeRhythmScore(intervals){
    if (intervals.length < 4) return 0;
    const ms = intervals.slice(-8);
    const n = ms.length;
    const mean = ms.reduce((a,b)=>a+b,0)/n;
    const varr = ms.reduce((a,b)=>a+(b-mean)*(b-mean),0)/n;
    const sd = Math.sqrt(varr);

    const target = 380;
    const dist = Math.abs(mean - target);
    let speedScore = 1 - clamp(dist/420, 0, 1);
    const tooFast = mean < 160 ? (160 - mean)/120 : 0;
    speedScore = speedScore - clamp(tooFast, 0, 1);
    const stabilityScore = 1 - clamp(sd/220, 0, 1);
    const last = ms[n-1];
    const spamPenalty = last < 120 ? 0.9 : (last < 160 ? 0.55 : 0);

    let score01 = 0.55*speedScore + 0.45*stabilityScore;
    score01 = score01 - spamPenalty;
    return clamp((score01*2 - 1), -1, 1);
  }

  // ===== State (所持金マイナスOK) =====
  const state = {
    startMoney: 10000,
    money: 10000,
    running: false,
    tLeft: GAME_SECONDS,
    presses: 0,
    mode: "balanced",
    counts: Object.fromEntries(ORDER.map(k=>[k,0])),
    maxMoney: 10000,
    minMoney: 10000,
    bias: 0,
    rhythm: 0,
    lastMainAt: 0,
    intervals: []
  };

  function setEnabled(on){
    drawBtn.classList.toggle("disabled", !on);
    btnThanks.classList.toggle("disabled", !on);
    btnHarsh.classList.toggle("disabled", !on);
  }

  function updateTop(){
    timeEl.textContent = state.tLeft.toFixed(1);
    moneyEl.textContent = moneyInt().toLocaleString("ja-JP");
    moneyBigEl.textContent = fmtYen(moneyInt());
    pressesEl.textContent = String(state.presses);
    modeNameEl.textContent = modeLabel[state.mode] || "—";
    biasMeterEl.textContent = state.bias.toFixed(2);
    rhythmMeterEl.textContent = state.rhythm.toFixed(2);

    chartNowEl.textContent = fmtYen(moneyInt());
    const net = moneyInt() - state.startMoney;
    chartNetEl.textContent = fmtNet(net);
    chartNetEl.style.color = net>=0 ? "rgba(125,255,202,.95)" : "rgba(255,77,109,.95)";
  }

  function decayBias(dt){
    const k = 1.6;
    state.bias *= Math.exp(-k * dt);
    if (Math.abs(state.bias) < 0.01) state.bias = 0;
  }

  function pressThanks(){
    if (!state.running) return;
    const now = performance.now();
    const recently = (now - (pressThanks._last||0)) < 250;
    pressThanks._last = now;
    const add = recently ? 0.05 : 0.10;
    state.bias = clamp(state.bias + add, -1, 1);
    sfx.thanks();
    toast("ありがとう…運が少し寄った");
    pushConfetti(10);
    showFortuneBar(fortuneLabel.textContent || "吉", undefined, `偏り ${state.bias.toFixed(2)} / リズム ${state.rhythm.toFixed(2)}`);
    updateTop();
  }

  function pressHarsh(){
    if (!state.running) return;
    const now = performance.now();
    const recently = (now - (pressHarsh._last||0)) < 250;
    pressHarsh._last = now;
    const add = recently ? 0.06 : 0.12;
    state.bias = clamp(state.bias - add, -1, 1);
    sfx.harsh();
    toast("もっと頑張れよ…悪い方へ寄った");
    pushConfetti(6);
    showFortuneBar(fortuneLabel.textContent || "凶", undefined, `偏り ${state.bias.toFixed(2)} / リズム ${state.rhythm.toFixed(2)}`);
    updateTop();
  }

  function pickFortuneWithLogic(){
    const baseW = modeWeights[state.mode] || modeWeights.balanced;
    const w = applyInfluenceToWeights(baseW, state.bias, state.rhythm);
    return weightedPick(ORDER, w);
  }

  // ===== Chart =====
  const chart = document.getElementById("moneyChart");
  const cctx = chart.getContext("2d");
  const chartDPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  let chartData = []; // {t, v}
  let gameStartPerf = 0;

  if (!CanvasRenderingContext2D.prototype.roundRect) {
    CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r){
      r = Math.min(r, w/2, h/2);
      this.beginPath();
      this.moveTo(x+r,y);
      this.arcTo(x+w,y,x+w,y+h,r);
      this.arcTo(x+w,y+h,x,y+h,r);
      this.arcTo(x,y+h,x,y,r);
      this.arcTo(x,y,x+w,y,r);
      this.closePath();
      return this;
    };
  }

  function resizeChart(){
    const rect = chart.getBoundingClientRect();
    const cssW = Math.max(10, rect.width);
    const cssH = 220;
    chart.width  = Math.floor(cssW * chartDPR);
    chart.height = Math.floor(cssH * chartDPR);
  }

  function addChartPoint(force=false){
    const t = state.running ? (performance.now() - gameStartPerf) / 1000 : 0;
    const v = moneyInt();
    const last = chartData[chartData.length-1];
    if (!force && last){
      if (Math.abs(last.v - v) === 0 && (t - last.t) < 0.18) return;
    }
    chartData.push({t, v});
    if (chartData.length > 900) chartData.shift();
  }

  function niceBounds(minV, maxV){
    if (minV === maxV) { minV -= 100; maxV += 100; }
    const range = maxV - minV;
    const pad = Math.max(120, range * 0.12);
    return {min: minV - pad, max: maxV + pad}; // ← マイナスあり前提で0クランプしない
  }

  function drawChart(){
    const w = chart.width, h = chart.height;
    cctx.clearRect(0,0,w,h);

    cctx.save();
    cctx.scale(chartDPR, chartDPR);
    const W = w / chartDPR, H = h / chartDPR;

    const PAD_L = 58, PAD_R = 10, PAD_T = 10, PAD_B = 20;
    const x0 = PAD_L, y0 = PAD_T;
    const x1 = W - PAD_R, y1 = H - PAD_B;

    if (!chartData.length){
      cctx.fillStyle = "rgba(232,236,255,.60)";
      cctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, sans-serif";
      cctx.fillText("スタートすると推移が表示される", x0, y0 + 14);
      cctx.restore();
      return;
    }

    const minVraw = Math.min(...chartData.map(p=>p.v));
    const maxVraw = Math.max(...chartData.map(p=>p.v));
    const {min:minV, max:maxV} = niceBounds(minVraw, maxVraw);

    const mapX = (t)=> x0 + (t / CHART_TMAX) * (x1 - x0);
    const mapY = (v)=> y1 - ((v - minV) / (maxV - minV)) * (y1 - y0);

    // grid
    cctx.strokeStyle = "rgba(255,255,255,.08)";
    cctx.lineWidth = 1;
    for (let i=0;i<=3;i++){
      const yy = y0 + (i/3)*(y1-y0);
      cctx.beginPath(); cctx.moveTo(x0, yy); cctx.lineTo(x1, yy); cctx.stroke();
    }

    // Y labels
    const fmt = (n)=> fmtYen(n);
    cctx.fillStyle = "rgba(232,236,255,.55)";
    cctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace";
    cctx.fillText(fmt(maxV), 6, y0 + 10);
    cctx.fillText(fmt((minV+maxV)/2), 6, (y0+y1)/2 + 5);
    cctx.fillText(fmt(minV), 6, y1);

    // line
    cctx.strokeStyle = "rgba(125,255,202,.92)";
    cctx.lineWidth = 2;
    cctx.beginPath();
    let started = false;
    for (const p of chartData){
      const tt = Math.max(0, Math.min(CHART_TMAX, p.t));
      const xx = mapX(tt);
      const yy = mapY(p.v);
      if (!started){ cctx.moveTo(xx, yy); started = true; }
      else cctx.lineTo(xx, yy);
    }
    cctx.stroke();

    // last dot + guide
    const last = chartData[chartData.length - 1];
    const lt = Math.max(0, Math.min(CHART_TMAX, last.t));
    const lx = mapX(lt);
    const ly = mapY(last.v);

    cctx.strokeStyle = "rgba(255,255,255,.10)";
    cctx.lineWidth = 1;
    cctx.beginPath(); cctx.moveTo(lx, y0); cctx.lineTo(lx, y1); cctx.stroke();

    cctx.fillStyle = "rgba(255,255,255,.95)";
    cctx.beginPath(); cctx.arc(lx, ly, 3.5, 0, Math.PI*2); cctx.fill();

    // value bubble
    const bubble = fmt(last.v);
    cctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace";
    const tw = cctx.measureText(bubble).width;
    const bx = Math.min(x1 - (tw+10), Math.max(x0, lx + 8));
    const by = Math.max(y0 + 12, Math.min(y1 - 10, ly));
    cctx.fillStyle = "rgba(0,0,0,.35)";
    cctx.strokeStyle = "rgba(255,255,255,.14)";
    cctx.lineWidth = 1;
    cctx.roundRect(bx, by-14, tw+10, 18, 8);
    cctx.fill(); cctx.stroke();
    cctx.fillStyle = "rgba(232,236,255,.88)";
    cctx.fillText(bubble, bx+5, by);

    cctx.restore();
  }

  // ===== Game control =====
  function resetAll(){
    modalBackdrop.style.display = "none";

    state.mode = modeSel.value;
    state.money = state.startMoney;
    state.tLeft = GAME_SECONDS;
    state.running = false;
    state.presses = 0;
    state.counts = Object.fromEntries(ORDER.map(k=>[k,0]));
    state.maxMoney = state.startMoney;
    state.minMoney = state.startMoney;

    state.bias = 0;
    state.rhythm = 0;
    state.lastMainAt = 0;
    state.intervals = [];

    setEnabled(false);
    showFortuneBar("—", undefined, "偏り 0.00 / リズム 0.00");

    chartData = [];
    resizeChart();
    addChartPoint(true);
    drawChart();

    updateTop();
    toast("準備OK。モード選んでスタート。");
  }

  function startGame(){
    state.mode = modeSel.value;
    state.money = state.startMoney;
    state.tLeft = GAME_SECONDS;
    state.running = true;
    state.presses = 0;
    state.counts = Object.fromEntries(ORDER.map(k=>[k,0]));
    state.maxMoney = state.startMoney;
    state.minMoney = state.startMoney;

    state.bias = 0;
    state.rhythm = 0;
    state.lastMainAt = 0;
    state.intervals = [];

    setEnabled(true);
    sfx.boom();
    showFortuneBar("吉", 0, "偏り 0.00 / リズム 0.00");
    toast(`開始：所持金 ${fmtYen(state.money)} / モード：${modeLabel[state.mode]}`);

    gameStartPerf = performance.now();
    chartData = [];
    addChartPoint(true);
    drawChart();

    updateTop();
  }

  function endGame(){
    if (!state.running) { showResults(); return; }
    state.running = false;
    setEnabled(false);
    sfx.end();
    toast("結果を表示するよ。");
    showResults();
  }

  function doDraw(ev){
    if (!state.running) return;

    const now = performance.now();
    if (state.lastMainAt > 0){
      const interval = now - state.lastMainAt;
      state.intervals.push(interval);
      if (state.intervals.length > 14) state.intervals.shift();
    }
    state.lastMainAt = now;
    state.rhythm = computeRhythmScore(state.intervals);

    const rectPanel = leftPanel.getBoundingClientRect();
    const x = (ev?.clientX ?? (rectPanel.left + rectPanel.width/2)) - rectPanel.left;
    const y = (ev?.clientY ?? (rectPanel.top  + rectPanel.height*0.52)) - rectPanel.top;

    const f = pickFortuneWithLogic();
    state.counts[f]++;

    const vol = modeVolatility[state.mode] ?? 1.0;
    const base = 90 + Math.min(210, state.presses * 1.2);
    let delta = base * (fortuneMult[f]) * vol;

    if (state.rhythm > 0.70 && (f === "中吉" || f === "小吉") && Math.random() < 0.10) delta *= 1.25;
    if (state.rhythm < -0.65 && (f === "凶" || f === "大凶") && Math.random() < 0.12) delta *= 1.20;

    // ★ 所持金マイナスOK（0で止めない）
    const before = state.money;
    state.money = clamp(state.money + delta, -1e12, 1e12);
    state.presses++;

    state.maxMoney = Math.max(state.maxMoney, state.money);
    state.minMoney = Math.min(state.minMoney, state.money);

    showFortuneBar(f, delta, `偏り ${state.bias.toFixed(2)} / リズム ${state.rhythm.toFixed(2)}`);

    // FX
    sfx.tap();
    const abs = Math.abs(delta);
    const power = clamp(0.7 + Math.log10(abs+10)*0.25, 0.7, 2.0);
    pushRing(x, y);
    pushSparks(x, y, Math.floor(10 + power*12), power);
    if (f === "大吉") pushConfetti(18);
    if (f === "大凶") pushConfetti(10);
    if (delta > 0) sfx.good();
    if (delta < 0) sfx.bad();

    const sign = delta >= 0 ? "+" : "-";
    const text = `${sign}${fmtYen(abs)}`;
    const color = delta < 0 ? "rgba(255,77,109,1)" : "rgba(125,255,202,1)";
    spawnFloat(text, x, y, abs >= 3000 ? 28 : 20, color);

    // chart
    addChartPoint(true);
    drawChart();

    updateTop();
  }

  // ===== Bias decay / Timer =====
  let last = performance.now();
  function loop(now){
    const dt = Math.min(0.05, (now - last)/1000);
    last = now;

    if (state.running){
      state.tLeft -= dt;
      decayBias(dt);

      // chart moves smoothly
      if (!loop._acc) loop._acc = 0;
      loop._acc += dt;
      if (loop._acc >= 0.20){
        loop._acc = 0;
        addChartPoint(false);
        drawChart();
      }

      if (state.tLeft <= 0){
        state.tLeft = 0;
        updateTop();
        endGame();
      } else {
        updateTop();
      }
    }
    requestAnimationFrame(loop);
  }

  // ===== 5段階 総合判定（大吉〜末吉） =====
  function judge5(net){
    // 15秒なので少しシビア目の閾値（必要なら調整する）
    if (net >= 12000) return "大吉";
    if (net >=  6000) return "中吉";
    if (net >=     0) return "小吉";
    if (net >= -6000) return "吉";
    return "末吉";
  }

  function pct(n, total){
    if (!total) return "0%";
    return Math.round((n/total)*100) + "%";
  }
  function decideType(){
    const total = state.presses || 1;
    const c = state.counts;
    const good = c["大吉"] + c["中吉"] + c["小吉"];
    const bad  = c["凶"] + c["大凶"];
    const goodRate = good / total;
    const badRate  = bad  / total;
    const net = moneyInt() - state.startMoney;
    const range = state.maxMoney - state.minMoney;

    if (state.rhythm > 0.55 && goodRate > 0.36) return {type:"リズム職人型", advice:"一定テンポが財運を呼ぶ。今日は“同じ間隔”が武器。"};
    if (state.rhythm < -0.55 && badRate > 0.30) return {type:"連打破壊型", advice:"焦りの連打が損を呼ぶ。間を置くと運が戻る。"};
    if (state.bias > 0.35) return {type:"感謝増幅型", advice:"丁寧さが運を上げる。余計な一押しを我慢すると勝てる。"};
    if (state.bias < -0.35) return {type:"自己圧型", advice:"自分を責めると運が落ちる。言葉を優しくすると回る。"};
    if (range >= 20000) return {type:"ジェットコースター型", advice:"増えた直後が危険。『増えたら守る』をルール化すると強い。"};
    if (net < 0) return {type:"逆境耐久型", advice:"借金を恐れず修正できる。焦りの連打だけ避けると伸びる。"};
    return {type:"堅実積み上げ型", advice:"派手さより継続。小さな勝ちを積むと伸びる。"};
  }

  function showResults(){
    const total = state.presses || 0;
    const final = moneyInt();
    const net = final - state.startMoney;

    // ★ 5段階判定
    const judge = judge5(net);
    const t = decideType();

    resultTitle.textContent = `総合判定：${judge}`;
    resultSummary.innerHTML =
      `<div>開始：<b class="mono">¥10,000</b> ／ 終了：<b class="mono">${fmtYen(final)}</b> ／ 獲得：<b class="mono">${fmtNet(net)}</b> 円</div>
       <div>モード：<b>${modeLabel[state.mode]}</b> ／ 回数：<b>${total}</b> ／ 最大：<b class="mono">${fmtYen(state.maxMoney)}</b> ／ 最小：<b class="mono">${fmtYen(state.minMoney)}</b></div>
       <div>最終：偏り <b class="mono">${state.bias.toFixed(2)}</b> ／ リズム <b class="mono">${state.rhythm.toFixed(2)}</b></div>`;

    countTable.innerHTML = "";
    for (const name of ORDER){
      const n = state.counts[name] || 0;
      const tr = document.createElement("tr");
      tr.innerHTML = `<td><span class="badge">${name}</span></td><td>${n}</td><td>${pct(n, total)}</td>`;
      countTable.appendChild(tr);
    }
    resultTypeLine.innerHTML = `あなたのタイプ：<b>${t.type}</b> です`;
    resultAdviceLine.textContent = `注意：${t.advice}`;
    modalBackdrop.style.display = "flex";
  }

  // ===== Events =====
  function decayBias(dt){
    const k = 1.6;
    state.bias *= Math.exp(-k * dt);
    if (Math.abs(state.bias) < 0.01) state.bias = 0;
  }

  btnAudio.addEventListener("click", ()=>{
    ensureAudio();
    muted = false;
    btnAudio.textContent = "Audio READY";
    setTimeout(()=>btnAudio.textContent="Audio ON", 800);
  });

  btnReset.addEventListener("click", ()=>{
    ensureAudio();
    if (!confirm("リセットする？")) return;
    resetAll();
  });

  btnStart.addEventListener("click", ()=>{
    ensureAudio();
    modalBackdrop.style.display = "none";
    startGame();
  });

  btnEnd.addEventListener("click", ()=>{
    ensureAudio();
    endGame();
  });

  drawBtn.addEventListener("click", (e)=>doDraw(e));
  drawBtn.addEventListener("touchstart", (e)=>{ doDraw(e.touches[0]); }, {passive:true});

  btnThanks.addEventListener("click", ()=>pressThanks());
  btnHarsh.addEventListener("click", ()=>pressHarsh());

  btnClose.addEventListener("click", ()=>{ modalBackdrop.style.display="none"; });
  btnPrint.addEventListener("click", ()=>{ window.print(); });
  btnAgain.addEventListener("click", ()=>{
    ensureAudio();
    modalBackdrop.style.display="none";
    startGame();
  });

  // ===== Init =====
  resizeFx();
  resizeChart();
  requestAnimationFrame(fxLoop);
  resetAll();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>