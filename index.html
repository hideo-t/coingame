<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>コイン工場 - Mini Clicker</title>
  <style>
    :root{
      --bg:#0b0f1a; --panel:#0d1433; --panel2:#0a1028;
      --line:#22306a; --txt:#e8ecff; --muted:rgba(232,236,255,.75);
      --gold:#ffd43b; --pink:#ff4d6d; --blue:#93b4ff;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--txt);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;}
    .wrap{max-width:980px;margin:0 auto;padding:16px;display:flex;flex-direction:column;gap:12px;}
    .top{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .stats{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{background:var(--panel);border:1px solid var(--line);border-radius:999px;padding:8px 12px;font-size:13px}
    .pill b{font-size:14px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{background:#1b2550;color:#fff;border:1px solid #2a3a7a;border-radius:12px;padding:9px 12px;cursor:pointer}
    button:active{transform:translateY(1px)}
    button.secondary{background:transparent;border:1px solid var(--line);color:var(--txt)}
    .grid{display:grid;grid-template-columns: 1.2fr .8fr; gap:12px}
    @media (max-width:860px){ .grid{grid-template-columns:1fr;} }
    .panel{background:var(--panel2);border:1px solid var(--line);border-radius:16px;padding:14px;position:relative;overflow:hidden}
    .hint{font-size:13px;color:var(--muted);line-height:1.5}
    .coinArea{display:flex;flex-direction:column;gap:12px;align-items:center;justify-content:center;min-height:420px}
    .coinBtn{
      width:min(340px,70vw); aspect-ratio:1/1; border-radius:999px;
      background:radial-gradient(circle at 35% 30%, #fff1a6 0%, var(--gold) 35%, #f0b429 70%, #b07a12 100%);
      border:2px solid rgba(255,255,255,.22);
      box-shadow:0 18px 40px rgba(0,0,0,.35), inset 0 8px 18px rgba(255,255,255,.25);
      cursor:pointer; position:relative;
      user-select:none; -webkit-tap-highlight-color:transparent;
      display:grid; place-items:center;
      transition: transform .06s ease;
    }
    .coinBtn:active{transform:scale(.985)}
    .coinFace{font-weight:800;letter-spacing:.04em;font-size:22px;color:#342400;text-shadow:0 2px 0 rgba(255,255,255,.35)}
    .bigMoney{font-size:44px;font-weight:900;letter-spacing:.02em}
    .pulse{animation:pulse .18s ease}
    @keyframes pulse{0%{transform:scale(1)} 50%{transform:scale(1.05)} 100%{transform:scale(1)}}
    .shop{display:flex;flex-direction:column;gap:10px}
    .card{
      background:var(--panel); border:1px solid var(--line); border-radius:14px;
      padding:12px; display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .card .left{display:flex;flex-direction:column;gap:4px}
    .title{font-weight:800}
    .desc{font-size:12px;color:var(--muted)}
    .price{font-size:13px;color:var(--blue)}
    .buyRow{display:flex;gap:8px;align-items:center}
    .buy{white-space:nowrap}
    .badge{
      font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--line);
      background:rgba(147,180,255,.12); color:var(--txt)
    }
    .toast{position:absolute;left:12px;top:12px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.12);
      padding:8px 10px;border-radius:12px;font-size:13px;opacity:0;transform:translateY(-6px);transition:.18s}
    .toast.show{opacity:1;transform:translateY(0)}
    .float{
      position:absolute; pointer-events:none; font-weight:900;
      text-shadow:0 2px 10px rgba(0,0,0,.35);
      animation: floatUp .85s ease forwards;
      will-change: transform, opacity;
    }
    @keyframes floatUp{
      0%{transform:translate(-50%,-10px) scale(1); opacity:1}
      100%{transform:translate(-50%,-90px) scale(1.15); opacity:0}
    }
    .tiny{font-size:12px;color:var(--muted)}
    .hr{height:1px;background:rgba(255,255,255,.08);margin:8px 0}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="stats">
      <div class="pill">所持金：<b id="money">0</b></div>
      <div class="pill">クリック単価：<b id="clickValue">1</b></div>
      <div class="pill">秒間収入：<b id="pps">0</b></div>
      <div class="pill">クリ率：<b id="crit">0%</b></div>
    </div>
    <div class="actions">
      <button id="btnStart">Start（音有効）</button>
      <button id="btnMute" class="secondary">Sound: ON</button>
      <button id="btnReset" class="secondary">Reset</button>
    </div>
  </div>

  <div class="grid">
    <div class="panel" id="leftPanel">
      <div class="toast" id="toast"></div>
      <div class="coinArea">
        <div class="bigMoney" id="bigMoney">¥0</div>
        <div class="hint">コインをクリック / タップして稼ぐ。<br>アップグレードで「稼ぐ速度」が気持ちよく増える。</div>
        <div class="coinBtn" id="coinBtn" aria-label="coin">
          <div class="coinFace">COIN FACTORY</div>
        </div>
        <div class="tiny">※ オートは「秒間収入」が1以上なら必ず増えるよ。</div>
      </div>
    </div>

    <div class="panel">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <div>
          <div style="font-weight:900;font-size:18px">SHOP</div>
          <div class="tiny">買うたびに値段が上がる（中毒設計）。</div>
        </div>
        <span class="badge" id="goalBadge">次の目標：¥10,000</span>
      </div>

      <div class="hr"></div>

      <div class="shop">
        <div class="card">
          <div class="left">
            <div class="title">① クリック単価UP <span class="badge" id="lvClick">Lv 1</span></div>
            <div class="desc">1クリックの稼ぎが増える。</div>
            <div class="price">価格：<b id="priceClick">¥15</b> / 効果：+1</div>
          </div>
          <div class="buyRow"><button class="buy" id="buyClick">BUY</button></div>
        </div>

        <div class="card">
          <div class="left">
            <div class="title">② オート機械 <span class="badge" id="lvAuto">Lv 0</span></div>
            <div class="desc">放置でも増える。秒間収入が増える（PPS）。</div>
            <div class="price">価格：<b id="priceAuto">¥60</b> / 効果：+1 PPS</div>
          </div>
          <div class="buyRow"><button class="buy" id="buyAuto">BUY</button></div>
        </div>

        <div class="card">
          <div class="left">
            <div class="title">③ クリティカル改造 <span class="badge" id="lvCrit">Lv 0</span></div>
            <div class="desc">たまに「10倍」。最大50%。</div>
            <div class="price">価格：<b id="priceCrit">¥120</b> / 効果：+1%</div>
          </div>
          <div class="buyRow"><button class="buy" id="buyCrit">BUY</button></div>
        </div>
      </div>

      <div class="hr"></div>
      <div class="hint">セーブ：自動（2秒ごと＋購入時）。</div>
    </div>
  </div>
</div>

<script>
(() => {
  // DOM
  const moneyEl = document.getElementById("money");
  const bigMoneyEl = document.getElementById("bigMoney");
  const clickValueEl = document.getElementById("clickValue");
  const ppsEl = document.getElementById("pps");
  const critEl = document.getElementById("crit");
  const coinBtn = document.getElementById("coinBtn");
  const toastEl = document.getElementById("toast");
  const goalBadge = document.getElementById("goalBadge");
  const leftPanel = document.getElementById("leftPanel");

  const lvClickEl = document.getElementById("lvClick");
  const lvAutoEl  = document.getElementById("lvAuto");
  const lvCritEl  = document.getElementById("lvCrit");
  const priceClickEl = document.getElementById("priceClick");
  const priceAutoEl  = document.getElementById("priceAuto");
  const priceCritEl  = document.getElementById("priceCrit");

  const buyClickBtn = document.getElementById("buyClick");
  const buyAutoBtn  = document.getElementById("buyAuto");
  const buyCritBtn  = document.getElementById("buyCrit");

  const btnStart = document.getElementById("btnStart");
  const btnMute  = document.getElementById("btnMute");
  const btnReset = document.getElementById("btnReset");

  // Audio
  let audioCtx = null;
  let muted = false;
  let audioUnlocked = false;

  function ensureAudio() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === "suspended") audioCtx.resume();
    audioUnlocked = true;
  }
  function beep({freq=440, dur=0.06, type="sine", gain=0.05, when=0, slide=0}={}) {
    if (muted || !audioUnlocked) return;
    ensureAudio();
    const t0 = audioCtx.currentTime + when;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type;
    o.frequency.setValueAtTime(freq, t0);
    if (slide) o.frequency.exponentialRampToValueAtTime(Math.max(30, freq + slide), t0 + dur);
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(gain, t0 + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
    o.connect(g).connect(audioCtx.destination);
    o.start(t0);
    o.stop(t0 + dur + 0.02);
  }
  const sfx = {
    coin(){ beep({freq: 880, dur:0.045, type:"square", gain:0.035, slide:-220}); },
    crit(){ beep({freq: 1320, dur:0.06, type:"triangle", gain:0.06}); beep({freq: 1760, dur:0.08, type:"triangle", gain:0.06, when:0.06}); },
    buy(){  beep({freq: 523, dur:0.06, type:"triangle", gain:0.05}); beep({freq: 659, dur:0.08, type:"triangle", gain:0.05, when:0.07}); },
    no(){   beep({freq: 180, dur:0.10, type:"sawtooth", gain:0.05, slide:-60}); }
  };

  // State
  const KEY = "coin_factory_save_v2";
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

  const state = {
    money: 0,          // ★内部は小数OK
    clickValue: 1,
    pps: 0,
    critChance: 0,     // 0..0.5
    lvClick: 1,
    lvAuto: 0,
    lvCrit: 0,
    priceClick: 15,
    priceAuto: 60,
    priceCrit: 120,
    lastTick: performance.now()
  };

  const grow = { click: 1.22, auto: 1.26, crit: 1.28 };

  function moneyInt(){ return Math.floor(state.money + 1e-9); } // 表示/購入判定用
  function yenInt(n){ return "¥" + Math.floor(n).toLocaleString("ja-JP"); }
  function yenMoney(){ return "¥" + moneyInt().toLocaleString("ja-JP"); }

  function calcGoal(m){
    const steps = [10000,25000,50000,100000,250000,500000,1000000,2500000,5000000,10000000];
    for (const s of steps) if (m < s) return s;
    return Math.pow(2, Math.ceil(Math.log2(m+1)));
  }

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(()=>toastEl.classList.remove("show"), 900);
  }

  function spawnFloat(text, x, y, isCrit=false){
    const el = document.createElement("div");
    el.className = "float";
    el.textContent = text;
    el.style.left = x + "px";
    el.style.top  = y + "px";
    el.style.fontSize = isCrit ? "24px" : "18px";
    el.style.color = isCrit ? "var(--pink)" : "var(--gold)";
    leftPanel.appendChild(el);
    setTimeout(()=>el.remove(), 900);
  }

  function updateUI(){
    moneyEl.textContent = moneyInt().toLocaleString("ja-JP");
    bigMoneyEl.textContent = yenMoney();

    clickValueEl.textContent = String(state.clickValue);
    ppsEl.textContent = String(state.pps);
    critEl.textContent = Math.round(state.critChance*100) + "%";

    lvClickEl.textContent = "Lv " + state.lvClick;
    lvAutoEl.textContent  = "Lv " + state.lvAuto;
    lvCritEl.textContent  = "Lv " + state.lvCrit;

    priceClickEl.textContent = yenInt(state.priceClick);
    priceAutoEl.textContent  = yenInt(state.priceAuto);
    priceCritEl.textContent  = yenInt(state.priceCrit);

    buyClickBtn.style.opacity = (moneyInt() >= state.priceClick) ? "1" : ".55";
    buyAutoBtn.style.opacity  = (moneyInt() >= state.priceAuto) ? "1" : ".55";
    buyCritBtn.style.opacity  = (moneyInt() >= state.priceCrit) ? "1" : ".55";

    const g = calcGoal(moneyInt());
    goalBadge.textContent = "次の目標：" + yenInt(g);
  }

  function save(){
    const d = {
      money: state.money,
      clickValue: state.clickValue,
      pps: state.pps,
      critChance: state.critChance,
      lvClick: state.lvClick,
      lvAuto: state.lvAuto,
      lvCrit: state.lvCrit,
      priceClick: state.priceClick,
      priceAuto: state.priceAuto,
      priceCrit: state.priceCrit
    };
    localStorage.setItem(KEY, JSON.stringify(d));
  }

  function load(){
    const raw = localStorage.getItem(KEY);
    if (!raw) return;
    try{
      const d = JSON.parse(raw);
      if (!d) return;
      Object.assign(state, d);
      state.critChance = clamp(state.critChance, 0, 0.5);
      state.money = Number(state.money) || 0;
    }catch{}
  }

  function addMoney(amount){
    state.money += amount; // ★丸めない
    updateUI();
  }

  function doClick(ev){
    const rect = coinBtn.getBoundingClientRect();
    const x = (ev?.clientX ?? (rect.left + rect.width/2));
    const y = (ev?.clientY ?? (rect.top  + rect.height/2));

    let gain = state.clickValue;
    const isCrit = Math.random() < state.critChance;
    if (isCrit) gain *= 10;

    addMoney(gain);

    sfx.coin();
    coinBtn.classList.remove("pulse");
    void coinBtn.offsetWidth;
    coinBtn.classList.add("pulse");

    if (isCrit){
      sfx.crit();
      spawnFloat("CRIT +" + yenInt(gain) + "!!", x, y, true);
      toast("CRITICAL ×10!!");
    } else {
      spawnFloat("+" + yenInt(gain), x, y, false);
    }
  }

  function buy(kind){
    const m = moneyInt(); // ★購入判定は整数で
    if (kind === "click"){
      if (m < state.priceClick) { sfx.no(); toast("お金が足りない"); return; }
      state.money -= state.priceClick;
      state.clickValue += 1;
      state.lvClick += 1;
      state.priceClick = Math.ceil(state.priceClick * grow.click + 4);
      sfx.buy(); toast("単価UP！");
    }
    if (kind === "auto"){
      if (m < state.priceAuto) { sfx.no(); toast("お金が足りない"); return; }
      state.money -= state.priceAuto;
      state.pps += 1;
      state.lvAuto += 1;
      state.priceAuto = Math.ceil(state.priceAuto * grow.auto + 8);
      sfx.buy(); toast("オート機械稼働！");
    }
    if (kind === "crit"){
      if (m < state.priceCrit) { sfx.no(); toast("お金が足りない"); return; }
      if (state.critChance >= 0.5) { sfx.no(); toast("クリ率は最大"); return; }
      state.money -= state.priceCrit;
      state.critChance = clamp(state.critChance + 0.01, 0, 0.5);
      state.lvCrit += 1;
      state.priceCrit = Math.ceil(state.priceCrit * grow.crit + 12);
      sfx.buy(); toast("クリ率UP！");
    }
    updateUI();
    save();
  }

  // Passive income
  function tick(now){
    const dt = (now - state.lastTick) / 1000;
    state.lastTick = now;

    if (state.pps > 0){
      state.money += state.pps * dt; // ★小数のまま積み上がる
    }

    updateUI();
    requestAnimationFrame(tick);
  }

  // Events
  coinBtn.addEventListener("click", (e)=>doClick(e));
  coinBtn.addEventListener("touchstart", (e)=>{ doClick(e.touches[0]); }, {passive:true});

  buyClickBtn.addEventListener("click", ()=>buy("click"));
  buyAutoBtn.addEventListener("click",  ()=>buy("auto"));
  buyCritBtn.addEventListener("click",  ()=>buy("crit"));

  btnStart.addEventListener("click", ()=>{
    ensureAudio();
    toast("音OK。さあ稼ごう。");
  });

  btnMute.addEventListener("click", ()=>{
    ensureAudio();
    muted = !muted;
    btnMute.textContent = `Sound: ${muted ? "OFF" : "ON"}`;
    if (!muted) beep({freq:660,dur:0.06,type:"triangle",gain:0.05});
  });

  btnReset.addEventListener("click", ()=>{
    ensureAudio();
    const ok = confirm("セーブも含めてリセットする？");
    if (!ok) return;
    localStorage.removeItem(KEY);
    location.reload();
  });

  // Init
  load();
  updateUI();
  setInterval(save, 2000);
  requestAnimationFrame((t)=>{ state.lastTick = t; requestAnimationFrame(tick); });

})();
</script>
</body>
</html>