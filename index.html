<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ã‚³ã‚¤ãƒ³å·¥å ´ FESTIVAL - Dopamine Clicker</title>
  <style>
    :root{
      --bg:#0b0f1a; --panel:#0d1433; --panel2:#0a1028;
      --line:#22306a; --txt:#e8ecff; --muted:rgba(232,236,255,.78);
      --gold:#ffd43b; --pink:#ff4d6d; --blue:#93b4ff;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--txt);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;}
    .wrap{max-width:980px;margin:0 auto;padding:16px;display:flex;flex-direction:column;gap:12px;}
    .top{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .stats{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{background:rgba(13,20,51,.75);backdrop-filter: blur(6px);
      border:1px solid rgba(34,48,106,.85);border-radius:999px;padding:8px 12px;font-size:13px}
    .pill b{font-size:14px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{background:#1b2550;color:#fff;border:1px solid #2a3a7a;border-radius:12px;padding:9px 12px;cursor:pointer}
    button:active{transform:translateY(1px)}
    button.secondary{background:transparent;border:1px solid rgba(34,48,106,.95);color:var(--txt)}
    .grid{display:grid;grid-template-columns: 1.2fr .8fr; gap:12px}
    @media (max-width:860px){ .grid{grid-template-columns:1fr;} }

    /* ====== LEFT PANEL with festival background ====== */
    .panel{
      border-radius:18px; padding:14px; position:relative; overflow:hidden;
      border:1px solid rgba(34,48,106,.9);
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(147,180,255,.10), rgba(0,0,0,0)),
        radial-gradient(1200px 600px at 90% 0%, rgba(255,77,109,.08), rgba(0,0,0,0)),
        linear-gradient(180deg, rgba(10,16,40,.95), rgba(7,10,22,.95));
      box-shadow: 0 22px 55px rgba(0,0,0,.35);
      transform: translate3d(0,0,0);
    }
    .panel.right{
      background: linear-gradient(180deg, rgba(10,16,40,.95), rgba(7,10,22,.95));
    }

    /* animated colorful glow layer (strength increases) */
    .glow{
      position:absolute; inset:-60px; pointer-events:none; opacity:0.0;
      background:
        radial-gradient(400px 220px at 15% 20%, rgba(255,212,59,.28), rgba(0,0,0,0)),
        radial-gradient(460px 260px at 85% 25%, rgba(255,77,109,.26), rgba(0,0,0,0)),
        radial-gradient(520px 300px at 40% 85%, rgba(147,180,255,.22), rgba(0,0,0,0)),
        radial-gradient(520px 320px at 70% 80%, rgba(125,255,202,.18), rgba(0,0,0,0));
      filter: blur(18px);
      animation: drift 6s ease-in-out infinite;
      mix-blend-mode: screen;
    }
    @keyframes drift{
      0%{transform:translate(0,0) scale(1)}
      50%{transform:translate(18px,-12px) scale(1.03)}
      100%{transform:translate(0,0) scale(1)}
    }

    .hint{font-size:13px;color:var(--muted);line-height:1.5}
    .coinArea{display:flex;flex-direction:column;gap:12px;align-items:center;justify-content:center;min-height:420px}
    .bigMoney{font-size:44px;font-weight:900;letter-spacing:.02em;text-shadow:0 8px 22px rgba(0,0,0,.35)}
    .tiny{font-size:12px;color:rgba(232,236,255,.72)}

    .coinBtn{
      width:min(340px,70vw); aspect-ratio:1/1; border-radius:999px;
      background:radial-gradient(circle at 35% 30%, #fff1a6 0%, var(--gold) 35%, #f0b429 70%, #b07a12 100%);
      border:2px solid rgba(255,255,255,.22);
      box-shadow:0 18px 40px rgba(0,0,0,.35), inset 0 8px 18px rgba(255,255,255,.25);
      cursor:pointer; position:relative;
      user-select:none; -webkit-tap-highlight-color:transparent;
      display:grid; place-items:center;
      transition: transform .06s ease, filter .2s ease;
    }
    .coinBtn:active{transform:scale(.985)}
    .coinFace{font-weight:900;letter-spacing:.06em;font-size:21px;color:#342400;text-shadow:0 2px 0 rgba(255,255,255,.35)}

    /* juicy feedback */
    .pulse{animation:pulse .18s ease}
    @keyframes pulse{0%{transform:scale(1)} 50%{transform:scale(1.05)} 100%{transform:scale(1)}}

    .shake{animation: shake .26s ease}
    @keyframes shake{
      0%{transform:translate(0,0)}
      20%{transform:translate(-3px, 1px)}
      40%{transform:translate(4px,-2px)}
      60%{transform:translate(-2px,2px)}
      80%{transform:translate(2px, -1px)}
      100%{transform:translate(0,0)}
    }

    .toast{
      position:absolute;left:12px;top:12px;
      background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.12);
      padding:8px 10px;border-radius:12px;font-size:13px;
      opacity:0;transform:translateY(-6px);transition:.18s;
      backdrop-filter: blur(8px);
    }
    .toast.show{opacity:1;transform:translateY(0)}
    .float{
      position:absolute; pointer-events:none; font-weight:950;
      text-shadow:0 2px 16px rgba(0,0,0,.45);
      animation: floatUp .95s cubic-bezier(.12,.9,.2,1) forwards;
      will-change: transform, opacity;
      letter-spacing:.02em;
    }
    @keyframes floatUp{
      0%{transform:translate(-50%,-8px) scale(1); opacity:1}
      100%{transform:translate(-50%,-120px) scale(1.22); opacity:0}
    }

    /* Celebration banner */
    .banner{
      position:absolute; left:50%; top:28%;
      transform:translate(-50%,-50%);
      font-weight:1000; font-size:34px; letter-spacing:.04em;
      padding:10px 16px;
      border-radius:16px;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.14);
      opacity:0; pointer-events:none;
      text-align:center;
      backdrop-filter: blur(10px);
      text-shadow: 0 10px 28px rgba(0,0,0,.55);
    }
    .banner.show{animation: bannerPop 1.1s ease forwards}
    @keyframes bannerPop{
      0%{opacity:0; transform:translate(-50%,-60%) scale(.82)}
      18%{opacity:1; transform:translate(-50%,-50%) scale(1.06)}
      70%{opacity:1; transform:translate(-50%,-50%) scale(1.02)}
      100%{opacity:0; transform:translate(-50%,-40%) scale(.98)}
    }

    /* Right shop */
    .shop{display:flex;flex-direction:column;gap:10px}
    .card{
      background:rgba(13,20,51,.78); backdrop-filter: blur(8px);
      border:1px solid rgba(34,48,106,.9); border-radius:14px;
      padding:12px; display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .card .left{display:flex;flex-direction:column;gap:4px}
    .title{font-weight:900}
    .desc{font-size:12px;color:var(--muted)}
    .price{font-size:13px;color:var(--blue)}
    .buyRow{display:flex;gap:8px;align-items:center}
    .buy{white-space:nowrap}
    .badge{
      font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid rgba(34,48,106,.9);
      background:rgba(147,180,255,.12); color:var(--txt)
    }
    .hr{height:1px;background:rgba(255,255,255,.08);margin:8px 0}

    /* Particle canvas overlay */
    canvas.fx{
      position:absolute; inset:0; width:100%; height:100%;
      pointer-events:none;
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="stats">
      <div class="pill">æ‰€æŒé‡‘ï¼š<b id="money">0</b></div>
      <div class="pill">ã‚¯ãƒªãƒƒã‚¯å˜ä¾¡ï¼š<b id="clickValue">1</b></div>
      <div class="pill">ç§’é–“åå…¥ï¼š<b id="pps">0</b></div>
      <div class="pill">ã‚¯ãƒªç‡ï¼š<b id="crit">0%</b></div>
      <div class="pill">ãƒ•ã‚§ã‚¹Lvï¼š<b id="festLv">0</b></div>
    </div>
    <div class="actions">
      <button id="btnStart">Startï¼ˆéŸ³æœ‰åŠ¹ï¼‰</button>
      <button id="btnMute" class="secondary">Sound: ON</button>
      <button id="btnReset" class="secondary">Reset</button>
    </div>
  </div>

  <div class="grid">
    <div class="panel" id="leftPanel">
      <div class="glow" id="glow"></div>
      <canvas class="fx" id="fx"></canvas>
      <div class="toast" id="toast"></div>
      <div class="banner" id="banner"></div>

      <div class="coinArea">
        <div class="bigMoney" id="bigMoney">Â¥0</div>
        <div class="hint">ã‚¯ãƒªãƒƒã‚¯ã§ç¨¼ã â†’ è²·ã† â†’ ä¸–ç•ŒãŒæ´¾æ‰‹ã«ãªã‚‹ã€‚<br>å¤§å°ãƒ»CRITã§ãƒ•ã‚§ã‚¹ãŒçˆ†ç™ºã™ã‚‹ã‚ˆã€‚</div>
        <div class="coinBtn" id="coinBtn" aria-label="coin">
          <div class="coinFace">COIN FACTORY</div>
        </div>
        <div class="tiny">Tipï¼šã‚ªãƒ¼ãƒˆã‚’å°‘ã—å…¥ã‚Œã¦æ”¾ç½®åå…¥ãŒå‡ºã‚‹ã¨â€œæˆ»ã£ã¦ããŸããªã‚‹â€ã€‚</div>
      </div>
    </div>

    <div class="panel right">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <div>
          <div style="font-weight:1000;font-size:18px">SHOP</div>
          <div class="tiny">è²·ã†ãŸã³ã«å€¤æ®µãŒä¸ŠãŒã‚‹ï¼ˆä¸­æ¯’è¨­è¨ˆï¼‰ã€‚</div>
        </div>
        <span class="badge" id="goalBadge">æ¬¡ã®ç›®æ¨™ï¼šÂ¥10,000</span>
      </div>

      <div class="hr"></div>

      <div class="shop">
        <div class="card">
          <div class="left">
            <div class="title">â‘  ã‚¯ãƒªãƒƒã‚¯å˜ä¾¡UP <span class="badge" id="lvClick">Lv 1</span></div>
            <div class="desc">1ã‚¯ãƒªãƒƒã‚¯ã®ç¨¼ããŒå¢—ãˆã‚‹ã€‚ä½“æ„ŸãŒä¸€ç•ªæ°—æŒã¡ã„ã„ã€‚</div>
            <div class="price">ä¾¡æ ¼ï¼š<b id="priceClick">Â¥15</b> / åŠ¹æœï¼š+1</div>
          </div>
          <div class="buyRow"><button class="buy" id="buyClick">BUY</button></div>
        </div>

        <div class="card">
          <div class="left">
            <div class="title">â‘¡ ã‚ªãƒ¼ãƒˆæ©Ÿæ¢° <span class="badge" id="lvAuto">Lv 0</span></div>
            <div class="desc">æ”¾ç½®ã§ã‚‚å¢—ãˆã‚‹ã€‚ç§’é–“åå…¥ï¼ˆPPSï¼‰ãŒå¢—ãˆã‚‹ã€‚</div>
            <div class="price">ä¾¡æ ¼ï¼š<b id="priceAuto">Â¥60</b> / åŠ¹æœï¼š+1 PPS</div>
          </div>
          <div class="buyRow"><button class="buy" id="buyAuto">BUY</button></div>
        </div>

        <div class="card">
          <div class="left">
            <div class="title">â‘¢ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«æ”¹é€  <span class="badge" id="lvCrit">Lv 0</span></div>
            <div class="desc">ãŸã¾ã«ã€Œ10å€ã€ã€‚æœ€å¤§50%ã€‚</div>
            <div class="price">ä¾¡æ ¼ï¼š<b id="priceCrit">Â¥120</b> / åŠ¹æœï¼š+1%</div>
          </div>
          <div class="buyRow"><button class="buy" id="buyCrit">BUY</button></div>
        </div>
      </div>

      <div class="hr"></div>
      <div class="hint">ã‚»ãƒ¼ãƒ–ï¼šè‡ªå‹•ï¼ˆ2ç§’ã”ã¨ï¼‹è³¼å…¥æ™‚ï¼‰ã€‚</div>
    </div>
  </div>
</div>

<script>
(() => {
  // ===== DOM =====
  const moneyEl = document.getElementById("money");
  const bigMoneyEl = document.getElementById("bigMoney");
  const clickValueEl = document.getElementById("clickValue");
  const ppsEl = document.getElementById("pps");
  const critEl = document.getElementById("crit");
  const festLvEl = document.getElementById("festLv");

  const coinBtn = document.getElementById("coinBtn");
  const leftPanel = document.getElementById("leftPanel");
  const toastEl = document.getElementById("toast");
  const bannerEl = document.getElementById("banner");
  const glowEl = document.getElementById("glow");

  const goalBadge = document.getElementById("goalBadge");

  const lvClickEl = document.getElementById("lvClick");
  const lvAutoEl  = document.getElementById("lvAuto");
  const lvCritEl  = document.getElementById("lvCrit");
  const priceClickEl = document.getElementById("priceClick");
  const priceAutoEl  = document.getElementById("priceAuto");
  const priceCritEl  = document.getElementById("priceCrit");

  const buyClickBtn = document.getElementById("buyClick");
  const buyAutoBtn  = document.getElementById("buyAuto");
  const buyCritBtn  = document.getElementById("buyCrit");

  const btnStart = document.getElementById("btnStart");
  const btnMute  = document.getElementById("btnMute");
  const btnReset = document.getElementById("btnReset");

  // ===== Audio =====
  let audioCtx = null;
  let muted = false;
  let audioUnlocked = false;

  function ensureAudio() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === "suspended") audioCtx.resume();
    audioUnlocked = true;
  }
  function beep({freq=440, dur=0.06, type="sine", gain=0.05, when=0, slide=0}={}) {
    if (muted || !audioUnlocked) return;
    ensureAudio();
    const t0 = audioCtx.currentTime + when;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type;
    o.frequency.setValueAtTime(freq, t0);
    if (slide) o.frequency.exponentialRampToValueAtTime(Math.max(30, freq + slide), t0 + dur);
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(gain, t0 + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
    o.connect(g).connect(audioCtx.destination);
    o.start(t0);
    o.stop(t0 + dur + 0.02);
  }

  const sfx = {
    coin(){ beep({freq: 880, dur:0.045, type:"square", gain:0.035, slide:-220}); },
    crit(){ beep({freq: 1320, dur:0.06, type:"triangle", gain:0.06});
            beep({freq: 1760, dur:0.08, type:"triangle", gain:0.06, when:0.06}); },
    buy(){  beep({freq: 523, dur:0.06, type:"triangle", gain:0.05});
            beep({freq: 659, dur:0.08, type:"triangle", gain:0.05, when:0.07}); },
    no(){   beep({freq: 180, dur:0.10, type:"sawtooth", gain:0.05, slide:-60}); },
    boom(){ beep({freq: 220, dur:0.12, type:"sawtooth", gain:0.06, slide:-120});
            beep({freq: 440, dur:0.10, type:"triangle", gain:0.05, when:0.06}); }
  };

  // ===== State =====
  const KEY = "coin_factory_festival_v1";
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

  const state = {
    money: 0,          // float internal
    clickValue: 1,
    pps: 0,
    critChance: 0,     // 0..0.5
    lvClick: 1,
    lvAuto: 0,
    lvCrit: 0,
    priceClick: 15,
    priceAuto: 60,
    priceCrit: 120,
    lastTick: performance.now(),
    lastMilestone: 0,  // last celebrated threshold
    festLv: 0          // grows with milestones/crit
  };

  const grow = { click: 1.22, auto: 1.26, crit: 1.28 };

  function moneyInt(){ return Math.floor(state.money + 1e-9); }
  function yenInt(n){ return "Â¥" + Math.floor(n).toLocaleString("ja-JP"); }
  function yenMoney(){ return "Â¥" + moneyInt().toLocaleString("ja-JP"); }

  function calcGoal(m){
    const steps = [10000,25000,50000,100000,250000,500000,1000000,2500000,5000000,10000000];
    for (const s of steps) if (m < s) return s;
    return Math.pow(2, Math.ceil(Math.log2(m+1)));
  }

  // ===== UI helpers =====
  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(()=>toastEl.classList.remove("show"), 950);
  }
  function banner(msg){
    bannerEl.textContent = msg;
    bannerEl.classList.remove("show");
    void bannerEl.offsetWidth;
    bannerEl.classList.add("show");
  }
  function spawnFloat(text, x, y, size=18, cssColor="rgba(255,212,59,1)"){
    const el = document.createElement("div");
    el.className = "float";
    el.textContent = text;
    el.style.left = x + "px";
    el.style.top  = y + "px";
    el.style.fontSize = size + "px";
    el.style.color = cssColor;
    leftPanel.appendChild(el);
    setTimeout(()=>el.remove(), 1000);
  }
  function addShake(strength=1){
    // strength scales by re-triggering
    leftPanel.classList.remove("shake");
    void leftPanel.offsetWidth;
    leftPanel.classList.add("shake");
  }

  // ===== Festival level (gradually more colorful) =====
  function computeFestLv(m){
    // 0..10 (ish)
    const tiers = [0, 10000, 50000, 100000, 250000, 500000, 1000000, 2500000, 5000000, 10000000, 25000000];
    let lv = 0;
    for (let i=0;i<tiers.length;i++){
      if (m >= tiers[i]) lv = i;
    }
    return lv; // 0..10
  }
  function applyFestivalLook(){
    // glow opacity increases with festLv
    const lv = state.festLv;
    const op = clamp(0.06 + lv * 0.065, 0, 0.78);
    glowEl.style.opacity = op.toFixed(3);

    // coin brightness slightly increases
    const bright = 1 + lv * 0.03;
    const sat = 1 + lv * 0.05;
    coinBtn.style.filter = `brightness(${bright.toFixed(2)}) saturate(${sat.toFixed(2)})`;

    festLvEl.textContent = String(lv);
  }

  function updateUI(){
    moneyEl.textContent = moneyInt().toLocaleString("ja-JP");
    bigMoneyEl.textContent = yenMoney();

    clickValueEl.textContent = String(state.clickValue);
    ppsEl.textContent = String(state.pps);
    critEl.textContent = Math.round(state.critChance*100) + "%";

    lvClickEl.textContent = "Lv " + state.lvClick;
    lvAutoEl.textContent  = "Lv " + state.lvAuto;
    lvCritEl.textContent  = "Lv " + state.lvCrit;

    priceClickEl.textContent = yenInt(state.priceClick);
    priceAutoEl.textContent  = yenInt(state.priceAuto);
    priceCritEl.textContent  = yenInt(state.priceCrit);

    buyClickBtn.style.opacity = (moneyInt() >= state.priceClick) ? "1" : ".55";
    buyAutoBtn.style.opacity  = (moneyInt() >= state.priceAuto) ? "1" : ".55";
    buyCritBtn.style.opacity  = (moneyInt() >= state.priceCrit) ? "1" : ".55";

    const g = calcGoal(moneyInt());
    goalBadge.textContent = "æ¬¡ã®ç›®æ¨™ï¼š" + yenInt(g);

    // festival level from money + bonus from recent action
    const baseLv = computeFestLv(moneyInt());
    state.festLv = Math.max(state.festLv, baseLv);
    applyFestivalLook();
  }

  function save(){
    const d = {
      money: state.money,
      clickValue: state.clickValue,
      pps: state.pps,
      critChance: state.critChance,
      lvClick: state.lvClick,
      lvAuto: state.lvAuto,
      lvCrit: state.lvCrit,
      priceClick: state.priceClick,
      priceAuto: state.priceAuto,
      priceCrit: state.priceCrit,
      lastMilestone: state.lastMilestone,
      festLv: state.festLv
    };
    localStorage.setItem(KEY, JSON.stringify(d));
  }
  function load(){
    const raw = localStorage.getItem(KEY);
    if (!raw) return;
    try{
      const d = JSON.parse(raw);
      if (!d) return;
      Object.assign(state, d);
      state.critChance = clamp(state.critChance, 0, 0.5);
      state.money = Number(state.money) || 0;
      state.lastMilestone = Number(state.lastMilestone) || 0;
      state.festLv = Number(state.festLv) || 0;
    }catch{}
  }

  // ===== FX Canvas (confetti / sparks / rings) =====
  const fx = document.getElementById("fx");
  const fctx = fx.getContext("2d");
  const DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));

  function resizeFx(){
    const r = leftPanel.getBoundingClientRect();
    fx.width = Math.floor(r.width * DPR);
    fx.height = Math.floor(r.height * DPR);
  }
  window.addEventListener("resize", resizeFx);

  const particles = [];
  const rings = [];

  function rand(a,b){ return a + Math.random()*(b-a); }
  function hsl(h,s,l,a=1){ return `hsla(${h},${s}%,${l}%,${a})`; }

  function pushConfetti(burst=60){
    const r = leftPanel.getBoundingClientRect();
    const cx = r.width * 0.5;
    const cy = r.height * 0.35;

    const lv = state.festLv;
    const count = Math.floor(burst * (1 + lv*0.10));

    for (let i=0;i<count;i++){
      const hue = (Math.random()*360)|0;
      particles.push({
        type:"confetti",
        x: cx + rand(-40,40),
        y: cy + rand(-20,20),
        vx: rand(-140,140) * (0.9 + lv*0.06),
        vy: rand(-260,-120) * (0.95 + lv*0.05),
        g: rand(380,520),
        life: rand(1.1, 1.8) * (0.95 + lv*0.04),
        t: 0,
        rot: rand(0,Math.PI*2),
        vr: rand(-10,10),
        w: rand(5,10),
        h: rand(8,16),
        color: hsl(hue, 95, 60, 0.95)
      });
    }
  }

  function pushSparks(x,y,amount=22, power=1){
    const lv = state.festLv;
    const count = Math.floor(amount * (1 + lv*0.06));
    for (let i=0;i<count;i++){
      const ang = rand(0, Math.PI*2);
      const sp = rand(160, 420) * power * (0.95 + lv*0.05);
      const hue = (40 + rand(-20, 60) + lv*6) % 360;
      particles.push({
        type:"spark",
        x, y,
        vx: Math.cos(ang)*sp,
        vy: Math.sin(ang)*sp,
        g: rand(480, 820),
        life: rand(0.45, 0.75),
        t: 0,
        r: rand(1.2, 2.4),
        color: hsl(hue, 98, 64, 0.95)
      });
    }
  }

  function pushRing(x,y){
    const lv = state.festLv;
    rings.push({
      x, y,
      r: 10,
      vr: 520 * (0.95 + lv*0.04),
      life: 0.55,
      t: 0,
      color: hsl(rand(0,360), 95, 62, 0.75)
    });
  }

  function flash(intensity=0.25){
    // quick overlay flash via drawing in fx (one-shot)
    const r = leftPanel.getBoundingClientRect();
    fctx.save();
    fctx.scale(DPR,DPR);
    fctx.fillStyle = `rgba(255,255,255,${intensity})`;
    fctx.fillRect(0,0,r.width,r.height);
    fctx.restore();
  }

  function fxLoop(now){
    const r = leftPanel.getBoundingClientRect();
    const w = fx.width, h = fx.height;

    fctx.clearRect(0,0,w,h);
    fctx.save();
    fctx.scale(DPR,DPR);

    const dt = Math.min(0.033, (fxLoop._last ? (now - fxLoop._last)/1000 : 0.016));
    fxLoop._last = now;

    // Rings
    for (let i=rings.length-1;i>=0;i--){
      const it = rings[i];
      it.t += dt;
      it.r += it.vr * dt;
      const a = 1 - (it.t / it.life);
      if (a <= 0){ rings.splice(i,1); continue; }
      fctx.beginPath();
      fctx.strokeStyle = it.color.replace("0.75", String(0.75*a));
      fctx.lineWidth = 4 * a;
      fctx.arc(it.x, it.y, it.r, 0, Math.PI*2);
      fctx.stroke();
    }

    // Particles
    for (let i=particles.length-1;i>=0;i--){
      const p = particles[i];
      p.t += dt;
      const a = 1 - (p.t / p.life);
      if (a <= 0){ particles.splice(i,1); continue; }

      p.vy += p.g * dt;
      p.x += p.vx * dt;
      p.y += p.vy * dt;

      if (p.type === "confetti"){
        p.rot += p.vr * dt;
        fctx.save();
        fctx.translate(p.x, p.y);
        fctx.rotate(p.rot);
        fctx.globalAlpha = Math.max(0, a);
        fctx.fillStyle = p.color;
        fctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
        fctx.restore();
      } else {
        fctx.globalAlpha = Math.max(0, a);
        fctx.fillStyle = p.color;
        fctx.beginPath();
        fctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
        fctx.fill();
      }
    }

    fctx.restore();
    requestAnimationFrame(fxLoop);
  }

  // ===== Gameplay =====
  function addMoney(amount){
    state.money += amount;
    updateUI();
  }

  function celebrateMilestone(th){
    // Upgrade festival level a bit extra (sticky)
    state.festLv = Math.max(state.festLv, computeFestLv(th) + 1);

    sfx.boom();
    banner(`å¤§å°çªç ´ï¼ ${yenInt(th)} ğŸ‰`);
    toast("ãƒ•ã‚§ã‚¹ãƒ†ã‚£ãƒãƒ«åŠ é€Ÿï¼");
    addShake(1);

    // confetti + rings
    const rr = leftPanel.getBoundingClientRect();
    pushConfetti(90);
    pushRing(rr.width*0.5, rr.height*0.35);
    pushRing(rr.width*0.5, rr.height*0.35);
    flash(0.20);

    save();
  }

  function checkMilestones(prevM, curM){
    // milestone thresholds: 1ä¸‡, 5ä¸‡, 10ä¸‡, 50ä¸‡, 100ä¸‡, 500ä¸‡, 1000ä¸‡...
    const milestones = [10000,50000,100000,500000,1000000,5000000,10000000,50000000,100000000];
    for (const th of milestones){
      if (prevM < th && curM >= th){
        state.lastMilestone = Math.max(state.lastMilestone, th);
        celebrateMilestone(th);
      }
    }
  }

  function doClick(ev){
    const rect = coinBtn.getBoundingClientRect();
    const x = (ev?.clientX ?? (rect.left + rect.width/2)) - leftPanel.getBoundingClientRect().left;
    const y = (ev?.clientY ?? (rect.top  + rect.height/2)) - leftPanel.getBoundingClientRect().top;

    const prev = moneyInt();

    let gain = state.clickValue;
    const isCrit = Math.random() < state.critChance;
    if (isCrit) gain *= 10;

    addMoney(gain);

    // normal juicy feedback
    sfx.coin();
    coinBtn.classList.remove("pulse");
    void coinBtn.offsetWidth;
    coinBtn.classList.add("pulse");

    if (isCrit){
      // CRIT FESTIVAL: more sparks + flash + shake + banner
      state.festLv = Math.min(15, state.festLv + 1); // temporary ramp
      sfx.crit();
      banner(`CRITICAL Ã—10 !!  +${yenInt(gain)} ğŸ’¥`);
      toast("ãƒ‰ã‚«ãƒ³ï¼");
      addShake(1.2);
      flash(0.18);

      pushSparks(x, y, 34, 1.25);
      pushRing(x, y);

      spawnFloat(`+${yenInt(gain)}!!`, x, y, 26, "rgba(255,77,109,1)");
      spawnFloat("Ã—10", x+30, y-10, 22, "rgba(255,212,59,1)");
    } else {
      // small spark depending on festival level
      const small = 6 + state.festLv*1.2;
      pushSparks(x, y, small, 0.55);
      spawnFloat("+" + yenInt(gain), x, y, 18, "rgba(255,212,59,1)");
    }

    // milestone check
    checkMilestones(prev, moneyInt());
  }

  function buy(kind){
    const m = moneyInt();
    if (kind === "click"){
      if (m < state.priceClick) { sfx.no(); toast("ãŠé‡‘ãŒè¶³ã‚Šãªã„"); return; }
      state.money -= state.priceClick;
      state.clickValue += 1;
      state.lvClick += 1;
      state.priceClick = Math.ceil(state.priceClick * grow.click + 4);
      sfx.buy(); toast("å˜ä¾¡UPï¼");
    }
    if (kind === "auto"){
      if (m < state.priceAuto) { sfx.no(); toast("ãŠé‡‘ãŒè¶³ã‚Šãªã„"); return; }
      state.money -= state.priceAuto;
      state.pps += 1;
      state.lvAuto += 1;
      state.priceAuto = Math.ceil(state.priceAuto * grow.auto + 8);
      sfx.buy(); toast("ã‚ªãƒ¼ãƒˆæ©Ÿæ¢°ç¨¼åƒï¼");
    }
    if (kind === "crit"){
      if (m < state.priceCrit) { sfx.no(); toast("ãŠé‡‘ãŒè¶³ã‚Šãªã„"); return; }
      if (state.critChance >= 0.5) { sfx.no(); toast("ã‚¯ãƒªç‡ã¯æœ€å¤§"); return; }
      state.money -= state.priceCrit;
      state.critChance = clamp(state.critChance + 0.01, 0, 0.5);
      state.lvCrit += 1;
      state.priceCrit = Math.ceil(state.priceCrit * grow.crit + 12);
      sfx.buy(); toast("ã‚¯ãƒªç‡UPï¼");
    }
    updateUI();
    save();
  }

  // Passive income
  function tick(now){
    const prev = moneyInt();
    const dt = (now - state.lastTick) / 1000;
    state.lastTick = now;

    if (state.pps > 0){
      state.money += state.pps * dt;
    }

    // mild passive celebration: when festival level is high, subtle confetti sometimes
    if (state.festLv >= 6 && Math.random() < 0.0025){
      const rr = leftPanel.getBoundingClientRect();
      pushSparks(rr.width*rand(0.25,0.75), rr.height*rand(0.35,0.8), 10, 0.6);
    }

    const cur = moneyInt();
    if (cur !== prev){
      updateUI();
      checkMilestones(prev, cur);
    } else {
      // still keep UI fresh for goal badge / fest lv
      updateUI();
    }

    requestAnimationFrame(tick);
  }

  // ===== Wire =====
  coinBtn.addEventListener("click", (e)=>doClick(e));
  coinBtn.addEventListener("touchstart", (e)=>{ doClick(e.touches[0]); }, {passive:true});

  buyClickBtn.addEventListener("click", ()=>buy("click"));
  buyAutoBtn.addEventListener("click",  ()=>buy("auto"));
  buyCritBtn.addEventListener("click",  ()=>buy("crit"));

  btnStart.addEventListener("click", ()=>{
    ensureAudio();
    toast("éŸ³OKã€‚ãƒ•ã‚§ã‚¹å§‹ã‚ã‚ˆã†ã€‚");
    sfx.buy();
  });
  btnMute.addEventListener("click", ()=>{
    ensureAudio();
    muted = !muted;
    btnMute.textContent = `Sound: ${muted ? "OFF" : "ON"}`;
    if (!muted) beep({freq:660,dur:0.06,type:"triangle",gain:0.05});
  });
  btnReset.addEventListener("click", ()=>{
    ensureAudio();
    const ok = confirm("ã‚»ãƒ¼ãƒ–ã‚‚å«ã‚ã¦ãƒªã‚»ãƒƒãƒˆã™ã‚‹ï¼Ÿ");
    if (!ok) return;
    localStorage.removeItem(KEY);
    location.reload();
  });

  // ===== Init =====
  load();
  updateUI();
  resizeFx();
  setInterval(save, 2000);

  requestAnimationFrame((t)=>{
    state.lastTick = t;
    requestAnimationFrame(tick);
  });
  requestAnimationFrame(fxLoop);

})();
</script>
</body>
</html>